---
layout: lay_post
title: "Btrace一次实战"
date: 2020-04-29
categories: Btrace
tags: 工具
author: lvyafei
---

## 1.Btrace

Btrace：一个用于Java平台的安全的动态跟踪工具

https://github.com/btraceio/btrace
<!--more-->

## 2.使用记录

一次发布完程序后，想看下某个方法的入参和出参数据？首先想到的是使用日志输出，但是就为了看下这个东西打印下日志发布下程序，有点大动干戈了。想到Btrace可以监控方法的执行，索性使用这个来看下。

准备工作：

先下载Btrace，放在java程序运行的机器上。

编写Btrace脚本文件

```
import com.sun.btrace.annotations.*;
import xxx.commons.dto.TradeBusParamDTO;
import xxx.commons.bo.ShareHolderInfo;
import java.util.List;
import com.sun.btrace.BTraceUtils;
import xxx.kesb.external.bus.domain.model.ExternalCommonParameter;
import static com.sun.btrace.BTraceUtils.println;

@BTrace
public class TradeBusLog {

    @OnMethod(
        clazz="zts.intelli.app.trade.impl.TradeBusServiceImpl",
        method="queryShareHolderInfo",location=@Location(Kind.ENTRY)
    )
    public static void oncall(TradeBusParamDTO tradeBusParamDTO, String capitalNo,String market, String cursor) {
        //println("queryShareHolderInfo begin...");
        //BTraceUtils.printFields(tradeBusParamDTO);
        //println("queryShareHolderInfo end...");
    }

    @OnMethod(
        clazz="zts.intelli.app.trade.impl.TradeBusServiceImpl",
        method="buildCommonParameter",location=@Location(Kind.RETURN)
    )
    public static void oncall1(TradeBusParamDTO tradeBusParamDTO, @Return ExternalCommonParameter result) {
        println("build begin...");
        BTraceUtils.printFields(tradeBusParamDTO);
        BTraceUtils.printFields(result);
        println("build end...");
    }
}
```

需要将依赖的包：xxx-backend-commons-model-1.15.6-SNAPSHOT.jar，xxx-trade-commons-model-1.7.10.jar，xxx-core-1.2.1.jar复制到当前目录下：

执行命令：

```
# btrace/bin/btrace -cp .:xxx-backend-commons-model-1.15.6-SNAPSHOT.jar:xxx-trade-commons-model-1.7.10.jar:xxx-core-1.2.1.jar <PID> TradeBusLog.java
```
注意:如果是docker运行的程序，需要进入docker容器中进行跟踪


```
import com.sun.btrace.annotations.*;
import com.sun.btrace.BTraceUtils;
import static com.sun.btrace.BTraceUtils.println;
import java.util.List;
import xxx.commons.dto.EntrustParamDTO;
import xxx.kesb.internal.jzjy.domain.EntrustCMD;

@BTrace
public class TradeBusLog {

    @OnMethod(
        clazz="zts.intelli.app.trade.impl.TradeBusServiceImpl",
        method="buildEntrustInfo",location=@Location(Kind.ENTRY)
    )
    public static void oncall1(EntrustCMD entrustCMD, EntrustParamDTO entrustParamDTO) {
        println("build begin...");
        BTraceUtils.printFields(entrustCMD);
        BTraceUtils.printFields(entrustParamDTO);
        println("build end...");
    }
}
```

执行命令：

```
# btrace/bin/btrace -cp .:xxx-trade-commons-model-1.7.10.jar:internal-jzjy-domain-1.2.2.jar <PID> TradeBusLog.java
```